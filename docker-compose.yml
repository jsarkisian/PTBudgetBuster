#version: "3.8"

services:
  toolbox:
    build:
      context: .
      dockerfile: Dockerfile.toolbox
    container_name: mcp-pt-toolbox
    volumes:
      - scan-data:/opt/pentest/data
      - tool-configs:/opt/pentest/configs
    networks:
      - mcp-pt-net
    # To reach targets on a Tailscale tailnet, uncomment the line below
    # and comment out the 'networks' block above. This gives the toolbox
    # direct access to the host's network (including Tailscale).
    # network_mode: "host"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    cap_add:
      - NET_RAW
      - NET_ADMIN
    restart: unless-stopped

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: mcp-pt-backend
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    volumes:
      - scan-data:/opt/pentest/data
      - ./backend:/app
      - ./configs:/configs
      - /root/.ssh:/root/.ssh
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - TOOLBOX_HOST=toolbox
      - TOOLBOX_PORT=9500
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000}
    depends_on:
      - toolbox
    networks:
      - mcp-pt-net
    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: mcp-pt-frontend
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    depends_on:
      - backend
    networks:
      - mcp-pt-net
    restart: unless-stopped

volumes:
  scan-data:
  tool-configs:

networks:
  mcp-pt-net:
    driver: bridge
